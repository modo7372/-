<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QnA Hub ‚Äî Study Intelligence</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0d0f14;
  --surface: #141720;
  --card: #1a1e2a;
  --card2: #1f2436;
  --text: #e8eaf0;
  --muted: #8892a4;
  --primary: #5b8dee;
  --primary-glow: rgba(91,141,238,0.18);
  --green: #3ecf8e;
  --green-glow: rgba(62,207,142,0.15);
  --yellow: #f5a623;
  --yellow-glow: rgba(245,166,35,0.15);
  --red: #f06058;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 48px rgba(0,0,0,0.6);
  --font: 'Sora', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

[data-theme="light"] {
  --bg: #f0f2f7;
  --surface: #ffffff;
  --card: #ffffff;
  --card2: #f7f8fc;
  --text: #1a1f2e;
  --muted: #6b7280;
  --primary: #3b6fd4;
  --primary-glow: rgba(59,111,212,0.12);
  --green: #059669;
  --green-glow: rgba(5,150,105,0.1);
  --yellow: #d97706;
  --yellow-glow: rgba(217,119,6,0.1);
  --red: #dc2626;
  --border: rgba(0,0,0,0.08);
  --border2: rgba(0,0,0,0.14);
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.12);
}

[data-theme="sepia"] {
  --bg: #f5edd8;
  --surface: #fffbf2;
  --card: #fffbf2;
  --card2: #fdf5e0;
  --text: #3d2b1f;
  --muted: #8b7355;
  --primary: #c0622d;
  --primary-glow: rgba(192,98,45,0.12);
  --green: #5a7a3a;
  --green-glow: rgba(90,122,58,0.12);
  --yellow: #b8860b;
  --yellow-glow: rgba(184,134,11,0.1);
  --red: #a0392a;
  --border: rgba(0,0,0,0.1);
  --border2: rgba(0,0,0,0.18);
  --shadow: 0 2px 12px rgba(0,0,0,0.1);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.15);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
  overflow-x: hidden;
}

::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; opacity: 0.6; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes pulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.5; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}
@keyframes toastIn {
  from { opacity: 0; transform: translateY(20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.animate-fade-up { animation: fadeUp 0.35s ease-out both; }
.animate-fade-in { animation: fadeIn 0.25s ease-out both; }
.animate-slide-in { animation: slideIn 0.25s ease-out both; }
.animate-spin { animation: spin 0.8s linear infinite; }
.animate-pulse { animation: pulse 1.5s ease-in-out infinite; }

/* Stagger utility */
.stagger > * { animation: fadeUp 0.3s ease-out both; }
.stagger > *:nth-child(1) { animation-delay: 0.03s; }
.stagger > *:nth-child(2) { animation-delay: 0.06s; }
.stagger > *:nth-child(3) { animation-delay: 0.09s; }
.stagger > *:nth-child(4) { animation-delay: 0.12s; }
.stagger > *:nth-child(5) { animation-delay: 0.15s; }
.stagger > *:nth-child(n+6) { animation-delay: 0.18s; }

/* Glassmorphism card */
.glass {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

/* Pill */
.pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.02em;
}

/* Btn */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border2);
  background: var(--card2);
  color: var(--text);
  transition: all 0.2s;
  white-space: nowrap;
  font-family: var(--font);
}
.btn:hover { background: var(--surface); border-color: var(--primary); color: var(--primary); }
.btn.btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
.btn.btn-primary:hover { opacity: 0.88; }
.btn.btn-ghost { background: transparent; border-color: transparent; }
.btn.btn-ghost:hover { background: var(--card2); border-color: var(--border); color: var(--primary); }
.btn:disabled { opacity: 0.45; cursor: not-allowed; }

/* Input */
.input {
  background: var(--card2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  padding: 8px 12px;
  transition: border-color 0.2s, box-shadow 0.2s;
  outline: none;
  width: 100%;
}
.input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
.input::placeholder { color: var(--muted); }

/* Tab */
.tab-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid transparent;
  background: transparent;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
  white-space: nowrap;
  font-family: var(--font);
}
.tab-btn:hover { color: var(--text); background: var(--card2); }
.tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 12px var(--primary-glow); }
.tab-btn.active-unsolved { background: var(--yellow); color: #fff; box-shadow: 0 2px 12px var(--yellow-glow); }
.tab-btn.active-fav { background: var(--yellow); color: #fff; }

/* Tag chip */
.tag-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  background: var(--card2);
  border: 1px solid var(--border2);
  color: var(--muted);
}

/* Progress bar */
.progress-bar {
  height: 6px;
  background: var(--card2);
  border-radius: 3px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.progress-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s cubic-bezier(.4,0,.2,1);
}

/* Stat card */
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.stat-num { font-size: 28px; font-weight: 800; line-height: 1; }
.stat-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

/* Option rows */
.opt-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card2);
  font-size: 14px;
  transition: background 0.15s;
}
.opt-row.correct { background: var(--green-glow); border-color: var(--green); color: var(--green); }
.opt-row.selected-wrong { background: rgba(240,96,88,0.12); border-color: var(--red); color: var(--red); }

/* Practice mode */
.quiz-btn {
  padding: 12px 20px;
  border-radius: 8px;
  border: 2px solid var(--border2);
  background: var(--card2);
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  width: 100%;
}
.quiz-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: var(--primary-glow); }
.quiz-btn.correct { border-color: var(--green); background: var(--green-glow); color: var(--green); font-weight: 600; }
.quiz-btn.wrong { border-color: var(--red); background: rgba(240,96,88,0.12); color: var(--red); }
.quiz-btn:disabled { cursor: default; }

/* Report */
.report-section { margin-bottom: 28px; }
.report-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 10px; }

/* Dropdown */
.dropdown {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  min-width: 100%;
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  z-index: 100;
  overflow: hidden;
  animation: fadeUp 0.15s ease-out;
  max-height: 320px;
  overflow-y: auto;
}
.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.1s;
}
.dropdown-item:hover { background: var(--card2); }

/* Toast */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  z-index: 9999;
  padding: 12px 20px;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 8px;
  animation: toastIn 0.3s ease-out;
  max-width: 320px;
}

/* Section splitter */
.section-divider {
  height: 1px;
  background: var(--border);
  margin: 8px 0;
}

/* Mono ID badge */
.id-badge {
  font-family: var(--mono);
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 5px;
  background: var(--primary-glow);
  color: var(--primary);
  border: 1px solid var(--primary);
  font-weight: 500;
}

/* Scrollable pill row */
.pill-row {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
}
.pill-row::-webkit-scrollbar { height: 3px; }

/* Upload zone */
.upload-zone {
  border: 2px dashed var(--border2);
  border-radius: var(--radius);
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}
.upload-zone:hover, .upload-zone.drag-over {
  border-color: var(--primary);
  background: var(--primary-glow);
}

/* Compact question card */
.q-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: border-color 0.2s, box-shadow 0.2s;
  overflow: hidden;
}
.q-card:hover { border-color: var(--border2); }
.q-card.completed { border-left: 3px solid var(--green); opacity: 0.85; }
.q-card.unsolved { border-left: 3px solid var(--yellow); }

/* Tooltip */
.tooltip-wrap { position: relative; }
.tooltip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: var(--bg);
  padding: 4px 8px;
  border-radius: 5px;
  font-size: 11px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 999;
}
.tooltip-wrap:hover .tooltip { display: block; }

/* Sidebar overlay */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  animation: fadeIn 0.2s;
}
.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  max-width: 95vw;
  height: 100vh;
  background: var(--surface);
  border-left: 1px solid var(--border2);
  z-index: 201;
  overflow-y: auto;
  animation: slideIn 0.25s ease-out;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Header */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 50;
  padding: 0 24px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

/* Responsive */
@media (max-width: 640px) {
  .sidebar { width: 100vw; }
  .header { padding: 0 14px; }
  .toast { right: 14px; bottom: 14px; }
}

/* Shimmer loading */
.shimmer {
  background: linear-gradient(90deg, var(--card) 25%, var(--card2) 50%, var(--card) 75%);
  background-size: 200% auto;
  animation: shimmer 1.5s linear infinite;
  border-radius: 6px;
}

/* Modal */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.2s;
}
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 16px;
  width: 100%;
  max-width: 720px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 28px;
  box-shadow: var(--shadow-lg);
  animation: fadeUp 0.25s ease-out;
}

/* Note textarea */
.note-area {
  background: var(--card2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 10px;
  resize: vertical;
  min-height: 70px;
  width: 100%;
  outline: none;
  transition: border-color 0.2s;
}
.note-area:focus { border-color: var(--primary); }

/* Progress ring */
.ring { transform: rotate(-90deg); }

/* Table */
table.report-table { width: 100%; border-collapse: collapse; font-size: 13px; }
table.report-table th { text-align: left; padding: 8px 12px; color: var(--muted); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; border-bottom: 1px solid var(--border2); }
table.report-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
table.report-table tr:last-child td { border-bottom: none; }

/* Highlight search match */
mark { background: var(--primary-glow); color: var(--primary); border-radius: 3px; padding: 0 2px; font-weight: 700; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback, memo } = React;

// ==================== CONFIG ====================
const AVAILABLE_FILES = [
  " Infections.txt"
  // Add more files here
];
const STORAGE_KEY_PREFIX = "qna_hub_v3_";
const VIRTUALIZE_THRESHOLD = 80; // virtualize when > N visible items

// ==================== UTILS ====================
const esc = (s) => String(s).replace(/</g,"&lt;").replace(/>/g,"&gt;");

function debounce(fn, ms) {
  let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
}

function highlight(text, query) {
  if (!query || !text) return text;
  const safe = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  try {
    const re = new RegExp(`(${safe})`, 'gi');
    const parts = text.split(re);
    return parts.map((p, i) => re.test(p) ? <mark key={i}>{p}</mark> : p);
  } catch { return text; }
}

function saveLocal(key, data) {
  try { localStorage.setItem(STORAGE_KEY_PREFIX + key, JSON.stringify(data)); } catch {}
}
function loadLocal(key, fallback) {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_PREFIX + key);
    return raw != null ? JSON.parse(raw) : fallback;
  } catch { return fallback; }
}

// ==================== ICONS ====================
const I = {
  Search: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>,
  Upload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>,
  Copy: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>,
  File: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>,
  Download: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  Eye: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
  EyeOff: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
  Star: ({filled}) => <svg width="16" height="16" viewBox="0 0 24 24" fill={filled?"currentColor":"none"} stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round" style={{color: filled ? "var(--yellow)" : "var(--muted)"}}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
  Check: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
  CheckCircle: ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{color:"var(--green)"}}><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01" stroke="white" strokeWidth="2.5"/></svg>,
  Circle: ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{color:"var(--muted)"}}><circle cx="12" cy="12" r="10"/></svg>,
  Loader: () => <svg className="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>,
  Filter: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
  Tag: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
  ChevronDown: ({size=14}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="6 9 12 15 18 9"/></svg>,
  ChevronUp: ({size=14}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="18 15 12 9 6 15"/></svg>,
  X: ({size=14}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  List: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r="1" fill="currentColor"/><circle cx="3" cy="12" r="1" fill="currentColor"/><circle cx="3" cy="18" r="1" fill="currentColor"/></svg>,
  BarChart: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><rect x="18" y="3" width="4" height="18"/><rect x="10" y="8" width="4" height="13"/><rect x="2" y="13" width="4" height="8"/></svg>,
  Brain: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2a2.5 2.5 0 015 0v.5a2.5 2.5 0 01-5 0V2zM12 4.5v15m-4.5-9.5a2.5 2.5 0 00-2.5 2.5v.5a2.5 2.5 0 002.5 2.5M7.5 10a4.5 4.5 0 00-4.5 4.5M16.5 10a2.5 2.5 0 012.5 2.5v.5a2.5 2.5 0 01-2.5 2.5M16.5 10a4.5 4.5 0 014.5 4.5"/></svg>,
  Question: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  Note: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
  Shuffle: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>,
  Settings: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>,
  Moon: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>,
  Sun: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
  Warning: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
};

// ==================== PARSER ====================
function parseTextData(text) {
  const lines = text.split('\n');
  const parsed = [];
  let idCounter = 1;
  const uniqueLessons = new Set();

  let separator = '\t';
  const sepMatch = text.match(/#separator:(.+)/);
  if (sepMatch) {
    const s = sepMatch[1].trim();
    separator = s === 'tab' ? '\t' : s === 'comma' ? ',' : s;
  }

  let explicitTagCol = -1;
  const tagColMatch = text.match(/#tags column:(\d+)/i);
  if (tagColMatch) explicitTagCol = parseInt(tagColMatch[1], 10) - 1;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (!line.trim() || line.startsWith('#')) continue;

    const cols = line.split(separator);
    if (cols.length < 2) continue;

    let lesson = "General";
    let qText = cols[0].trim();
    let optStartIndex = 1;

    const col0 = cols[0].trim();
    if (cols.length >= 3 && (
      col0.includes('::') ||
      /page\s*\d+/i.test(col0) ||
      /mcq/i.test(col0) ||
      /tropical/i.test(col0) ||
      /infections/i.test(col0)
    )) {
      lesson = col0;
      qText = cols[1] ? cols[1].trim() : "Unknown";
      optStartIndex = 2;
    }

    uniqueLessons.add(lesson);

    let options = [], answerKey = '', answerText = '', explanation = '', tag = '';

    if (explicitTagCol !== -1 && cols.length > explicitTagCol && cols[explicitTagCol].trim()) {
      tag = cols[explicitTagCol].trim();
      cols[explicitTagCol] = '';
    }

    let ansIndex = -1;
    for (let c = optStartIndex; c < cols.length; c++) {
      const val = cols[c].trim().toUpperCase();
      if (/^[A-E]$/.test(val)) { ansIndex = c; break; }
    }

    if (ansIndex !== -1) {
      for (let c = optStartIndex; c < ansIndex; c++) {
        if (cols[c].trim()) options.push(cols[c].trim());
      }
      answerKey = cols[ansIndex].trim();
      answerText = cols[ansIndex + 1] ? cols[ansIndex + 1].trim() : '';
      let remaining = cols.slice(ansIndex + 2).map(c => c.trim());

      if (!tag) {
        let lastIdx = -1;
        for (let k = remaining.length - 1; k >= 0; k--) {
          if (remaining[k]) { lastIdx = k; break; }
        }
        if (lastIdx !== -1) { tag = remaining[lastIdx]; remaining[lastIdx] = ''; }
      }
      const explParts = remaining.filter(c => c);
      if (explParts.length > 0) explanation = explParts.join(" | ");
    } else {
      options = cols.slice(optStartIndex, cols.length - 2).filter(c => c.trim());
      answerText = cols[cols.length - 2] ? cols[cols.length - 2].trim() : '';
      if (!tag) tag = cols[cols.length - 1] ? cols[cols.length - 1].trim() : '';
      else explanation = cols[cols.length - 1] ? cols[cols.length - 1].trim() : '';
    }

    if (!qText) continue;

    parsed.push({ id: idCounter++, lesson, question: qText, options, answerKey, answerText, explanation, tag });
  }

  return { parsed, lessons: Array.from(uniqueLessons) };
}

// ==================== VIRTUAL LIST ====================
function VirtualList({ items, renderItem, itemHeight = 200, overscan = 5, containerStyle = {} }) {
  const containerRef = useRef(null);
  const [scrollTop, setScrollTop] = useState(0);
  const [containerHeight, setContainerHeight] = useState(600);

  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;
    setContainerHeight(el.clientHeight || 600);

    const handleScroll = () => setScrollTop(el.scrollTop);
    const handleResize = () => setContainerHeight(el.clientHeight);
    el.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleResize);
    return () => { el.removeEventListener('scroll', handleScroll); window.removeEventListener('resize', handleResize); };
  }, []);

  const totalHeight = items.length * itemHeight;
  const startIdx = Math.max(0, Math.floor(scrollTop / itemHeight) - overscan);
  const endIdx = Math.min(items.length - 1, Math.ceil((scrollTop + containerHeight) / itemHeight) + overscan);

  const visibleItems = [];
  for (let i = startIdx; i <= endIdx; i++) {
    visibleItems.push(
      <div key={items[i].id} style={{ position: 'absolute', top: i * itemHeight, left: 0, right: 0, minHeight: itemHeight }}>
        {renderItem(items[i], i)}
      </div>
    );
  }

  return (
    <div ref={containerRef} style={{ overflowY: 'auto', height: '100%', ...containerStyle }}>
      <div style={{ position: 'relative', height: totalHeight }}>
        {visibleItems}
      </div>
    </div>
  );
}

// ==================== QUESTION CARD ====================
const QuestionCard = memo(function QuestionCard({
  q, isCollapsed, isFavorite, isCompleted, isUnsolved,
  displaySettings, searchQuery,
  onToggleCollapse, onToggleFavorite, onToggleCompleted,
  onOpenNote, noteText, compact,
}) {
  // Per-card answer visibility: null = follow global, true = force show, false = force hide
  const [localAnswer, setLocalAnswer] = useState(null);
  const showAnswerEffective = localAnswer !== null ? localAnswer : displaySettings.showAnswer;

  const hl = (text) => highlight(text, searchQuery);

  return (
    <div
      className={`q-card animate-fade-in ${isCompleted ? 'completed' : ''} ${isUnsolved && !isCompleted ? 'unsolved' : ''}`}
      style={{ marginBottom: compact ? 8 : 14 }}
    >
      {/* Card Header */}
      <div
        style={{
          display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start',
          gap: 12, padding: compact ? '12px 14px' : '16px 18px',
          cursor: 'pointer',
        }}
        onClick={() => onToggleCollapse(q.id)}
      >
        <div style={{ display: 'flex', alignItems: 'flex-start', gap: 10, flex: 1 }}>
          {/* Complete toggle */}
          <button
            onClick={(e) => { e.stopPropagation(); onToggleCompleted(q.id); }}
            style={{ marginTop: 2, flexShrink: 0, background: 'none', border: 'none', cursor: 'pointer', color: 'var(--muted)', padding: 0 }}
            title={isCompleted ? "Mark unread" : "Mark done"}
          >
            {isCompleted ? <I.CheckCircle size={18}/> : <I.Circle size={18}/>}
          </button>

          <div style={{ flex: 1 }}>
            {/* Lesson badge */}
            {q.lesson && q.lesson !== "General" && (
              <div style={{ fontSize: 10, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.07em', color: 'var(--muted)', marginBottom: 4 }}>
                {q.lesson.length > 50 ? q.lesson.slice(0, 50) + '‚Ä¶' : q.lesson}
              </div>
            )}
            <div
              style={{
                fontSize: compact ? 13 : 14, fontWeight: 500, lineHeight: 1.55,
                textDecoration: isCompleted ? 'line-through' : 'none',
                opacity: isCompleted ? 0.7 : 1,
              }}
            >
              {hl(q.question)}
            </div>
          </div>
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: 6, flexShrink: 0 }}>
          {/* Individual answer toggle */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              setLocalAnswer(prev => {
                // Cycle: null(global) ‚Üí show ‚Üí hide ‚Üí null(global)
                if (prev === null) return true;
                if (prev === true) return false;
                return null;
              });
            }}
            title={localAnswer === null ? `Answer: following global (${displaySettings.showAnswer ? 'visible' : 'hidden'}) ‚Äî click to override` : localAnswer ? 'Answer: shown ‚Äî click to hide' : 'Answer: hidden ‚Äî click to reset'}
            style={{
              display: 'flex', alignItems: 'center', gap: 4,
              padding: '4px 8px', borderRadius: 6, border: 'none', cursor: 'pointer',
              fontFamily: 'var(--mono)', fontSize: 10, fontWeight: 700,
              transition: 'all 0.15s',
              background: localAnswer === true
                ? 'var(--green-glow)'
                : localAnswer === false
                  ? 'rgba(240,96,88,0.12)'
                  : 'var(--card2)',
              color: localAnswer === true
                ? 'var(--green)'
                : localAnswer === false
                  ? 'var(--red)'
                  : 'var(--muted)',
              border: localAnswer === true
                ? '1px solid var(--green)'
                : localAnswer === false
                  ? '1px solid var(--red)'
                  : '1px solid var(--border2)',
            }}
          >
            {localAnswer === true ? <I.Eye/> : localAnswer === false ? <I.EyeOff/> : <I.Eye/>}
            <span style={{ display: compact ? 'none' : undefined }}>
              {localAnswer === true ? 'Ans' : localAnswer === false ? 'Ans' : 'Ans'}
            </span>
          </button>

          <button
            onClick={(e) => { e.stopPropagation(); onOpenNote(q.id); }}
            style={{ background: noteText ? 'var(--primary-glow)' : 'none', border: 'none', cursor: 'pointer', padding: '4px 6px', borderRadius: 6, color: noteText ? 'var(--primary)' : 'var(--muted)' }}
            title="Notes"
          >
            <I.Note/>
          </button>
          <button
            onClick={(e) => { e.stopPropagation(); onToggleFavorite(q.id); }}
            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '4px 6px', borderRadius: 6 }}
            title="Favorite"
          >
            <I.Star filled={isFavorite}/>
          </button>
          <span className="id-badge">{q.id}</span>
          <div style={{ color: 'var(--muted)', padding: '2px 4px' }}>
            {isCollapsed ? <I.ChevronDown/> : <I.ChevronUp/>}
          </div>
        </div>
      </div>

      {/* Expanded Body */}
      {!isCollapsed && (
        <div style={{ borderTop: '1px solid var(--border)', padding: compact ? '10px 14px 14px' : '14px 18px 18px' }} className="animate-fade-in">
          {/* Options */}
          {displaySettings.showOptions && q.options && q.options.length > 0 && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 6, marginBottom: 10 }}>
              {q.options.map((opt, i) => {
                const char = String.fromCharCode(65 + i);
                const isCorrect = q.answerKey && char === q.answerKey.toUpperCase();
                return (
                  <div key={i} className={`opt-row ${showAnswerEffective && isCorrect ? 'correct' : ''}`}
                    style={{ fontSize: compact ? 12 : 14 }}>
                    <span style={{ fontWeight: 700, minWidth: 18, fontFamily: 'var(--mono)', fontSize: 12 }}>{char}.</span>
                    <span style={{ flex: 1, lineHeight: 1.5 }}>{hl(opt)}</span>
                    {showAnswerEffective && isCorrect && <I.Check/>}
                  </div>
                );
              })}
            </div>
          )}

          {/* Answer text (when no options) */}
          {showAnswerEffective && q.answerText && (!displaySettings.showOptions || q.options.length === 0) && (
            <div style={{
              background: 'var(--green-glow)', border: '1px solid var(--green)', borderRadius: 8,
              color: 'var(--green)', padding: '8px 12px', fontSize: compact ? 12 : 13,
              display: 'flex', gap: 8, alignItems: 'flex-start', marginBottom: 10
            }}>
              <I.Check/> <span><b>Answer:</b> {q.answerKey ? q.answerKey + ' ‚Äî ' : ''}{hl(q.answerText)}</span>
            </div>
          )}

          {/* Explanation */}
          {displaySettings.showExplanation && q.explanation && (
            <div style={{
              borderLeft: '3px solid var(--primary)', paddingLeft: 12, marginBottom: 10,
              fontSize: compact ? 11 : 12, color: 'var(--muted)', lineHeight: 1.6
            }}>
              <div style={{ fontSize: 10, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 2, color: 'var(--primary)' }}>Explanation</div>
              {hl(q.explanation)}
            </div>
          )}

          {/* Tag */}
          {displaySettings.showTags && q.tag && (
            <span className="tag-chip"><I.Tag/>{q.tag}</span>
          )}

          {/* Note preview */}
          {noteText && (
            <div style={{ marginTop: 8, padding: '6px 10px', background: 'var(--card2)', borderRadius: 6, fontSize: 11, fontFamily: 'var(--mono)', color: 'var(--muted)', borderLeft: '2px solid var(--yellow)', cursor: 'pointer' }}
              onClick={() => onOpenNote(q.id)}>
              üìù {noteText.length > 80 ? noteText.slice(0, 80) + '‚Ä¶' : noteText}
            </div>
          )}
        </div>
      )}
    </div>
  );
});

// ==================== PRACTICE MODE ====================
function PracticeMode({ questions, onClose }) {
  const [deck, setDeck] = useState(() => [...questions].sort(() => Math.random() - 0.5));
  const [idx, setIdx] = useState(0);
  const [selected, setSelected] = useState(null);
  const [showAnswer, setShowAnswer] = useState(false);
  const [score, setScore] = useState({ correct: 0, wrong: 0, skipped: 0 });
  const [done, setDone] = useState(false);

  const q = deck[idx];
  const progress = ((idx) / deck.length) * 100;

  const answer = (char) => {
    if (selected) return;
    setSelected(char);
    setShowAnswer(true);
    const correct = char === q.answerKey?.toUpperCase();
    setScore(s => ({ ...s, correct: s.correct + (correct ? 1 : 0), wrong: s.wrong + (correct ? 0 : 1) }));
  };

  const next = () => {
    if (idx + 1 >= deck.length) { setDone(true); return; }
    setIdx(i => i + 1);
    setSelected(null);
    setShowAnswer(false);
  };

  const skip = () => {
    setScore(s => ({ ...s, skipped: s.skipped + 1 }));
    next();
  };

  const restart = () => {
    setDeck([...questions].sort(() => Math.random() - 0.5));
    setIdx(0); setSelected(null); setShowAnswer(false);
    setScore({ correct: 0, wrong: 0, skipped: 0 }); setDone(false);
  };

  if (done) {
    const total = score.correct + score.wrong + score.skipped;
    const pct = Math.round((score.correct / total) * 100) || 0;
    return (
      <div className="modal-bg">
        <div className="modal" style={{ textAlign: 'center', maxWidth: 480 }}>
          <div style={{ fontSize: 48, marginBottom: 8 }}>{pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üí™'}</div>
          <div style={{ fontSize: 22, fontWeight: 800, marginBottom: 4 }}>Session Complete!</div>
          <div style={{ color: 'var(--muted)', marginBottom: 24 }}>{total} questions answered</div>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: 12, marginBottom: 24 }}>
            <div className="stat-card" style={{ alignItems: 'center' }}>
              <div className="stat-num" style={{ color: 'var(--green)' }}>{score.correct}</div>
              <div className="stat-label">Correct</div>
            </div>
            <div className="stat-card" style={{ alignItems: 'center' }}>
              <div className="stat-num" style={{ color: 'var(--red)' }}>{score.wrong}</div>
              <div className="stat-label">Wrong</div>
            </div>
            <div className="stat-card" style={{ alignItems: 'center' }}>
              <div className="stat-num" style={{ color: 'var(--muted)' }}>{score.skipped}</div>
              <div className="stat-label">Skipped</div>
            </div>
          </div>

          <div style={{ fontSize: 32, fontWeight: 800, color: pct >= 80 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : 'var(--red)', marginBottom: 20 }}>
            {pct}% Score
          </div>

          <div style={{ display: 'flex', gap: 10, justifyContent: 'center' }}>
            <button className="btn btn-primary" onClick={restart}>Try Again</button>
            <button className="btn" onClick={onClose}>Exit</button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="modal-bg">
      <div className="modal">
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <div style={{ fontWeight: 700, fontSize: 14 }}>Practice Mode <span style={{ color: 'var(--muted)', fontWeight: 400 }}>‚Äî {idx + 1} / {deck.length}</span></div>
          <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
            <span style={{ fontSize: 12, color: 'var(--green)', fontWeight: 600 }}>‚úì {score.correct}</span>
            <span style={{ fontSize: 12, color: 'var(--red)', fontWeight: 600 }}>‚úó {score.wrong}</span>
            <button className="btn btn-ghost" onClick={onClose} style={{ padding: '4px 8px' }}><I.X size={16}/></button>
          </div>
        </div>

        {/* Progress */}
        <div className="progress-bar" style={{ marginBottom: 20 }}>
          <div className="progress-bar-fill" style={{ width: `${progress}%`, background: 'var(--primary)' }}/>
        </div>

        {/* Question */}
        <div style={{ fontSize: 15, fontWeight: 500, lineHeight: 1.6, marginBottom: 20 }}>
          {q.question}
        </div>

        {/* Options */}
        {q.options && q.options.length > 0 ? (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 8, marginBottom: 20 }}>
            {q.options.map((opt, i) => {
              const char = String.fromCharCode(65 + i);
              const isCorrect = q.answerKey && char === q.answerKey.toUpperCase();
              const isSelected = selected === char;
              let cls = '';
              if (showAnswer && isCorrect) cls = 'correct';
              else if (showAnswer && isSelected && !isCorrect) cls = 'wrong';
              return (
                <button key={i} className={`quiz-btn ${cls}`} onClick={() => answer(char)} disabled={!!selected}>
                  <span style={{ fontFamily: 'var(--mono)', fontWeight: 700, marginRight: 8 }}>{char}.</span>{opt}
                </button>
              );
            })}
          </div>
        ) : (
          <div>
            {!showAnswer ? (
              <button className="btn btn-primary" onClick={() => { setShowAnswer(true); setSelected('revealed'); }}>Reveal Answer</button>
            ) : (
              <div style={{ padding: '12px 16px', background: 'var(--green-glow)', border: '1px solid var(--green)', borderRadius: 8, color: 'var(--green)', marginBottom: 16 }}>
                <b>Answer:</b> {q.answerKey ? q.answerKey + ' ‚Äî ' : ''}{q.answerText}
              </div>
            )}
          </div>
        )}

        {/* Explanation */}
        {showAnswer && q.explanation && (
          <div style={{ borderLeft: '3px solid var(--primary)', paddingLeft: 12, fontSize: 12, color: 'var(--muted)', marginBottom: 16 }}>
            <div style={{ fontSize: 10, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--primary)', marginBottom: 2 }}>Explanation</div>
            {q.explanation}
          </div>
        )}

        {/* Actions */}
        <div style={{ display: 'flex', gap: 10, justifyContent: 'flex-end' }}>
          {!selected && <button className="btn" onClick={skip}>Skip</button>}
          {(selected || showAnswer) && <button className="btn btn-primary" onClick={next}>{idx + 1 >= deck.length ? 'Finish' : 'Next ‚Üí'}</button>}
        </div>
      </div>
    </div>
  );
}

// ==================== REPORT MODAL ====================
function ReportModal({ questions, favoriteIds, completedIds, notes, onClose }) {
  const total = questions.length;
  const completed = completedIds.size;
  const favorites = favoriteIds.size;
  const unsolved = total - completed;
  const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
  const notedCount = Object.values(notes).filter(n => n && n.trim()).length;

  // Lesson breakdown
  const lessonMap = {};
  questions.forEach(q => {
    if (!lessonMap[q.lesson]) lessonMap[q.lesson] = { total: 0, done: 0 };
    lessonMap[q.lesson].total++;
    if (completedIds.has(q.id)) lessonMap[q.lesson].done++;
  });
  const lessons = Object.entries(lessonMap).sort((a, b) => b[1].total - a[1].total);

  // Tag breakdown
  const tagMap = {};
  questions.forEach(q => {
    if (q.tag) {
      if (!tagMap[q.tag]) tagMap[q.tag] = 0;
      tagMap[q.tag]++;
    }
  });
  const tags = Object.entries(tagMap).sort((a, b) => b[1] - a[1]).slice(0, 10);

  return (
    <div className="modal-bg" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: 680 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <div style={{ fontWeight: 800, fontSize: 18 }}>üìä Study Report</div>
          <button className="btn btn-ghost" onClick={onClose}><I.X size={16}/></button>
        </div>

        {/* Summary stats */}
        <div className="report-section">
          <div className="report-title">Overall Progress</div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))', gap: 10 }}>
            <div className="stat-card">
              <div className="stat-num">{total}</div>
              <div className="stat-label">Total Qs</div>
            </div>
            <div className="stat-card">
              <div className="stat-num" style={{ color: 'var(--green)' }}>{completed}</div>
              <div className="stat-label">Completed</div>
            </div>
            <div className="stat-card">
              <div className="stat-num" style={{ color: 'var(--yellow)' }}>{unsolved}</div>
              <div className="stat-label">Unsolved</div>
            </div>
            <div className="stat-card">
              <div className="stat-num" style={{ color: 'var(--yellow)' }}>{favorites}</div>
              <div className="stat-label">Favorites</div>
            </div>
            <div className="stat-card">
              <div className="stat-num" style={{ color: 'var(--primary)' }}>{notedCount}</div>
              <div className="stat-label">Notes</div>
            </div>
            <div className="stat-card" style={{ alignItems: 'center' }}>
              <div className="stat-num" style={{ color: pct >= 80 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : 'var(--red)' }}>{pct}%</div>
              <div className="stat-label">Progress</div>
            </div>
          </div>

          <div style={{ marginTop: 14 }}>
            <div className="progress-bar">
              <div className="progress-bar-fill" style={{ width: `${pct}%`, background: pct >= 80 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : 'var(--primary)' }}/>
            </div>
          </div>
        </div>

        {/* Lesson breakdown */}
        {lessons.length > 0 && (
          <div className="report-section">
            <div className="report-title">Lesson Breakdown ({lessons.length} lessons)</div>
            <div style={{ maxHeight: 240, overflowY: 'auto' }}>
              <table className="report-table">
                <thead>
                  <tr>
                    <th>Lesson</th>
                    <th style={{ textAlign: 'center' }}>Total</th>
                    <th style={{ textAlign: 'center' }}>Done</th>
                    <th style={{ width: 100 }}>Progress</th>
                  </tr>
                </thead>
                <tbody>
                  {lessons.map(([lesson, data]) => {
                    const p = Math.round((data.done / data.total) * 100);
                    return (
                      <tr key={lesson}>
                        <td style={{ fontSize: 12, maxWidth: 200 }}>
                          <div style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={lesson}>
                            {lesson.length > 40 ? lesson.slice(0, 40) + '‚Ä¶' : lesson}
                          </div>
                        </td>
                        <td style={{ textAlign: 'center', fontFamily: 'var(--mono)', fontSize: 12 }}>{data.total}</td>
                        <td style={{ textAlign: 'center', fontFamily: 'var(--mono)', fontSize: 12, color: 'var(--green)' }}>{data.done}</td>
                        <td>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                            <div className="progress-bar" style={{ flex: 1 }}>
                              <div className="progress-bar-fill" style={{ width: `${p}%`, background: p === 100 ? 'var(--green)' : 'var(--primary)' }}/>
                            </div>
                            <span style={{ fontSize: 10, fontFamily: 'var(--mono)', color: 'var(--muted)', minWidth: 28, textAlign: 'right' }}>{p}%</span>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Tags */}
        {tags.length > 0 && (
          <div className="report-section">
            <div className="report-title">Top Tags</div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
              {tags.map(([tag, count]) => (
                <span key={tag} className="tag-chip">
                  <I.Tag/>{tag} <span style={{ fontFamily: 'var(--mono)', color: 'var(--primary)' }}>√ó{count}</span>
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Export report as text */}
        <button className="btn" onClick={() => {
          let txt = `QnA Hub ‚Äî Study Report\n${'='.repeat(40)}\n\n`;
          txt += `Total Questions: ${total}\nCompleted: ${completed} (${pct}%)\nUnsolved: ${unsolved}\nFavorites: ${favorites}\nNotes: ${notedCount}\n\n`;
          txt += `Lesson Breakdown:\n${'-'.repeat(30)}\n`;
          lessons.forEach(([l, d]) => { txt += `${l}: ${d.done}/${d.total}\n`; });
          navigator.clipboard?.writeText(txt).then(() => alert('Copied to clipboard!'));
        }}>
          <I.Copy/> Copy Report
        </button>
      </div>
    </div>
  );
}

// ==================== NOTE MODAL ====================
function NoteModal({ qId, question, noteText, onSave, onClose }) {
  const [text, setText] = useState(noteText || '');
  return (
    <div className="modal-bg" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: 520 }}>
        <div style={{ fontWeight: 700, marginBottom: 8, fontSize: 14 }}>üìù Note ‚Äî Q{qId}</div>
        <div style={{ color: 'var(--muted)', fontSize: 12, marginBottom: 12, lineHeight: 1.5 }}>{question}</div>
        <textarea
          className="note-area"
          value={text}
          onChange={e => setText(e.target.value)}
          placeholder="Add your notes, mnemonics, reminders..."
          rows={6}
          autoFocus
        />
        <div style={{ display: 'flex', gap: 8, marginTop: 12, justifyContent: 'flex-end' }}>
          <button className="btn" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" onClick={() => { onSave(qId, text); onClose(); }}>Save Note</button>
        </div>
      </div>
    </div>
  );
}

// ==================== MAIN APP ====================
function App() {
  // File state
  const [activeFile, setActiveFile] = useState(AVAILABLE_FILES[0] || "");
  const [questions, setQuestions] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [fetchError, setFetchError] = useState(null);
  const [availableLessons, setAvailableLessons] = useState([]);
  const [isDragOver, setIsDragOver] = useState(false);

  // Interaction state (persisted to localStorage)
  const [favoriteIds, setFavoriteIds] = useState(() => new Set(loadLocal('favorites', [])));
  const [completedIds, setCompletedIds] = useState(() => new Set(loadLocal('completed', [])));
  const [notes, setNotes] = useState(() => loadLocal('notes', {}));

  // View state
  const [collapsedIds, setCollapsedIds] = useState(new Set());
  const [searchQuery, setSearchQuery] = useState("");
  const [debouncedSearch, setDebouncedSearch] = useState("");
  const [activeTab, setActiveTab] = useState('All');
  const [selectedLessons, setSelectedLessons] = useState(new Set());
  const [isLessonDropdownOpen, setIsLessonDropdownOpen] = useState(false);

  const [displaySettings, setDisplaySettings] = useState(() => loadLocal('display', {
    showOptions: true, showAnswer: true, showExplanation: true, showTags: true
  }));
  const [compact, setCompact] = useState(() => loadLocal('compact', false));
  const [theme, setTheme] = useState(() => loadLocal('theme', 'dark'));

  // UI state
  const [isExporting, setIsExporting] = useState(false);
  const [toast, setToast] = useState(null);
  const [showReport, setShowReport] = useState(false);
  const [showPractice, setShowPractice] = useState(false);
  const [noteModal, setNoteModal] = useState(null); // { qId, question }
  const [showSettings, setShowSettings] = useState(false);

  const searchDebounceRef = useRef(null);
  const fileInputRef = useRef(null);

  // ---- Persistence ----
  useEffect(() => { saveLocal('favorites', Array.from(favoriteIds)); }, [favoriteIds]);
  useEffect(() => { saveLocal('completed', Array.from(completedIds)); }, [completedIds]);
  useEffect(() => { saveLocal('notes', notes); }, [notes]);
  useEffect(() => { saveLocal('display', displaySettings); }, [displaySettings]);
  useEffect(() => { saveLocal('compact', compact); }, [compact]);
  useEffect(() => { saveLocal('theme', theme); }, [theme]);

  // ---- Theme ----
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  // ---- Search debounce ----
  const handleSearchChange = (val) => {
    setSearchQuery(val);
    clearTimeout(searchDebounceRef.current);
    searchDebounceRef.current = setTimeout(() => setDebouncedSearch(val), 200);
  };

  // ---- Toast ----
  const showToast = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  // ---- File loading ----
  const loadFile = (fileName) => {
    setIsLoading(true);
    setFetchError(null);
    setSearchQuery(''); setDebouncedSearch('');
    setSelectedLessons(new Set());
    setCollapsedIds(new Set());
    setActiveTab('All');

    fetch(fileName)
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(text => {
        const { parsed, lessons } = parseTextData(text);
        setQuestions(parsed);
        setAvailableLessons(lessons);
        setIsLoading(false);
        showToast(`Loaded ${parsed.length} questions`);
      })
      .catch(err => {
        setFetchError(`Cannot load "${fileName}". ${err.message}`);
        setIsLoading(false);
      });
  };

  // ---- File upload ----
  const handleFileUpload = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const { parsed, lessons } = parseTextData(text);
      setQuestions(parsed);
      setAvailableLessons(lessons);
      setActiveFile(file.name);
      setSearchQuery(''); setDebouncedSearch('');
      setSelectedLessons(new Set());
      setCollapsedIds(new Set());
      setActiveTab('All');
      setFetchError(null);
      showToast(`Loaded ${parsed.length} questions from "${file.name}"`);
    };
    reader.readAsText(file);
  };

  // ---- Auto-load first file ----
  useEffect(() => {
    if (activeFile && AVAILABLE_FILES.includes(activeFile)) loadFile(activeFile);
  }, []);

  // ---- Toggles ----
  const toggle = (setter) => (id) => {
    setter(prev => {
      const n = new Set(prev);
      n.has(id) ? n.delete(id) : n.add(id);
      return n;
    });
  };
  const toggleFavorite = toggle(setFavoriteIds);
  const toggleCompleted = toggle(setCompletedIds);
  const toggleCollapse = toggle(setCollapsedIds);

  const toggleCollapseAll = () => {
    if (collapsedIds.size > 0) setCollapsedIds(new Set());
    else setCollapsedIds(new Set(questions.map(q => q.id)));
  };

  const toggleLesson = (lesson) => {
    setSelectedLessons(prev => {
      const n = new Set(prev); n.has(lesson) ? n.delete(lesson) : n.add(lesson); return n;
    });
  };

  const saveNote = (qId, text) => {
    setNotes(prev => ({ ...prev, [qId]: text }));
    showToast('Note saved');
  };

  // ---- Filtered questions ----
  const visibleQuestions = useMemo(() => {
    let filtered = questions;

    if (selectedLessons.size > 0) filtered = filtered.filter(q => selectedLessons.has(q.lesson));

    const q = debouncedSearch.trim();
    if (q) {
      const range = q.match(/^(\d+)\s*-\s*(\d+)$/);
      const ids = q.match(/^(\d+\s*,\s*)*\d+$/);
      if (range) {
        const s = parseInt(range[1]), e = parseInt(range[2]);
        filtered = filtered.filter(x => x.id >= s && x.id <= e);
      } else if (ids) {
        const idList = q.split(',').map(x => parseInt(x.trim()));
        filtered = filtered.filter(x => idList.includes(x.id));
      } else {
        const lower = q.toLowerCase();
        filtered = filtered.filter(x =>
          x.question.toLowerCase().includes(lower) ||
          x.options.some(o => o.toLowerCase().includes(lower)) ||
          (x.explanation && x.explanation.toLowerCase().includes(lower)) ||
          (x.tag && x.tag.toLowerCase().includes(lower)) ||
          (x.answerText && x.answerText.toLowerCase().includes(lower))
        );
      }
    }

    if (activeTab === 'Favorites') filtered = filtered.filter(x => favoriteIds.has(x.id));
    else if (activeTab === 'Completed') filtered = filtered.filter(x => completedIds.has(x.id));
    else if (activeTab === 'Unsolved') filtered = filtered.filter(x => !completedIds.has(x.id));

    return filtered;
  }, [questions, debouncedSearch, activeTab, favoriteIds, completedIds, selectedLessons]);

  const progressPct = questions.length > 0 ? Math.round((completedIds.size / questions.length) * 100) : 0;

  // ---- Export ----
  const exportToText = () => {
    if (!visibleQuestions.length) return showToast('Nothing to export', 'warn');
    let text = `QnA Hub Export\n${'='.repeat(50)}\n\n`;
    visibleQuestions.forEach(q => {
      text += `[ID: ${q.id}] ${q.lesson !== 'General' ? '[' + q.lesson + ']' : ''}\n${q.question}\n`;
      if (displaySettings.showOptions && q.options.length > 0)
        q.options.forEach((o, i) => { text += `  ${String.fromCharCode(65+i)}) ${o}\n`; });
      if (displaySettings.showAnswer) text += `  ‚úì Answer: ${q.answerKey ? q.answerKey + ' ‚Äî ' : ''}${q.answerText}\n`;
      if (displaySettings.showExplanation && q.explanation) text += `  üìñ ${q.explanation}\n`;
      if (displaySettings.showTags && q.tag) text += `  üè∑ ${q.tag}\n`;
      if (notes[q.id]) text += `  üìù Note: ${notes[q.id]}\n`;
      text += `\n${'‚Äî'.repeat(40)}\n\n`;
    });
    navigator.clipboard?.writeText(text).then(() => showToast('Copied to clipboard!'));
  };

  const exportToPDF = () => {
    if (!visibleQuestions.length) return showToast('Nothing to export', 'warn');
    setIsExporting(true);
    showToast('Generating PDF...');
    const element = document.getElementById('q-list');
    html2pdf().set({
      margin: 0.5,
      filename: `QnA_${activeTab}_${Date.now()}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, windowWidth: 900 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['css', 'legacy'] }
    }).from(element).save().then(() => {
      setIsExporting(false); showToast('PDF exported!');
    }).catch(() => { setIsExporting(false); showToast('PDF failed', 'error'); });
  };

  // ---- Tabs config ----
  const tabs = [
    { id: 'All', label: 'All', count: questions.length, icon: <I.List/> },
    { id: 'Unsolved', label: 'Unsolved', count: questions.length - completedIds.size, icon: <I.Warning/> },
    { id: 'Favorites', label: 'Stars', count: favoriteIds.size, icon: <I.Star filled={activeTab==='Favorites'}/> },
    { id: 'Completed', label: 'Done', count: completedIds.size, icon: <I.CheckCircle/> },
  ];

  const practicePool = useMemo(() => visibleQuestions.filter(q => q.options && q.options.length > 0), [visibleQuestions]);

  // ---- Render ----
  return (
    <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>

      {/* === HEADER === */}
      <div className="header">
        {/* Logo */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexShrink: 0 }}>
          <div style={{ width: 32, height: 32, background: 'var(--primary)', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff', fontSize: 16, fontWeight: 900 }}>Q</div>
          <span style={{ fontWeight: 800, fontSize: 16, letterSpacing: '-0.02em' }}>QnA Hub</span>
        </div>

        {/* Center: file selector & upload */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 8, flex: 1, margin: '0 16px', maxWidth: 500 }}>
          {AVAILABLE_FILES.length > 1 && (
            <select className="input" style={{ maxWidth: 220 }} value={activeFile} onChange={e => { setActiveFile(e.target.value); loadFile(e.target.value); }}>
              {AVAILABLE_FILES.map(f => <option key={f} value={f}>{f}</option>)}
            </select>
          )}
          <button className="btn" onClick={() => fileInputRef.current?.click()} title="Upload .txt or .csv file">
            <I.Upload/> <span style={{ display: window.innerWidth > 500 ? undefined : 'none' }}>Upload</span>
          </button>
          <input ref={fileInputRef} type="file" accept=".txt,.csv,.tsv" style={{ display: 'none' }}
            onChange={e => { if (e.target.files[0]) handleFileUpload(e.target.files[0]); }}
          />
        </div>

        {/* Right: actions */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 6, flexShrink: 0 }}>
          {questions.length > 0 && <>
            <button className="btn btn-ghost" onClick={() => setShowReport(true)} title="Report">
              <I.BarChart/>
            </button>
            {practicePool.length > 0 && (
              <button className="btn btn-primary" onClick={() => setShowPractice(true)} style={{ padding: '7px 12px' }}>
                <I.Brain/> <span style={{ display: window.innerWidth > 600 ? undefined : 'none' }}>Practice</span>
              </button>
            )}
          </>}
          {/* Theme toggle */}
          <button className="btn btn-ghost" onClick={() => {
            const t = theme === 'dark' ? 'light' : theme === 'light' ? 'sepia' : 'dark';
            setTheme(t);
          }} title="Toggle theme">
            {theme === 'dark' ? <I.Sun/> : theme === 'light' ? <I.Moon/> : 'üìú'}
          </button>
        </div>
      </div>

      {/* === TABS + PROGRESS === */}
      {questions.length > 0 && (
        <div style={{ background: 'var(--surface)', borderBottom: '1px solid var(--border)', padding: '0 24px', position: 'sticky', top: 60, zIndex: 40 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 12, maxWidth: 1200, margin: '0 auto', height: 52 }}>
            <div style={{ display: 'flex', gap: 4, overflow: 'auto', paddingBottom: 2 }}>
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  className={`tab-btn ${activeTab === tab.id ? (tab.id === 'Unsolved' ? 'active-unsolved' : tab.id === 'Favorites' ? 'active-fav' : 'active') : ''}`}
                  onClick={() => setActiveTab(tab.id)}
                >
                  {tab.icon} {tab.label}
                  <span style={{ fontFamily: 'var(--mono)', fontSize: 10, opacity: 0.8, background: 'rgba(255,255,255,0.15)', padding: '1px 5px', borderRadius: 4 }}>
                    {tab.count}
                  </span>
                </button>
              ))}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexShrink: 0 }}>
              <span style={{ fontSize: 12, color: 'var(--muted)', fontFamily: 'var(--mono)' }}>{progressPct}%</span>
              <div className="progress-bar" style={{ width: 100 }}>
                <div className="progress-bar-fill" style={{ width: `${progressPct}%`, background: progressPct >= 80 ? 'var(--green)' : 'var(--primary)' }}/>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* === TOOLBAR === */}
      {questions.length > 0 && !isLoading && (
        <div style={{ background: 'var(--surface)', padding: '12px 24px', borderBottom: '1px solid var(--border)' }}>
          <div style={{ maxWidth: 1200, margin: '0 auto', display: 'flex', flexWrap: 'wrap', gap: 10, alignItems: 'center' }}>

            {/* Lesson filter */}
            <div style={{ position: 'relative', minWidth: 180 }}>
              <button className="btn" onClick={() => setIsLessonDropdownOpen(v => !v)} style={{ width: '100%' }}>
                <I.Filter/>
                {selectedLessons.size === 0 ? 'All Lessons' : `${selectedLessons.size} lesson(s)`}
                <I.ChevronDown/>
              </button>
              {isLessonDropdownOpen && (
                <div className="dropdown" style={{ width: 280 }}>
                  <div className="dropdown-item" onClick={() => { setSelectedLessons(new Set()); setIsLessonDropdownOpen(false); }}
                    style={{ color: 'var(--primary)', fontWeight: 700, borderBottom: '1px solid var(--border)' }}>
                    ‚úï Clear filter
                  </div>
                  {availableLessons.map(l => (
                    <div key={l} className="dropdown-item" onClick={() => toggleLesson(l)}>
                      <input type="checkbox" checked={selectedLessons.has(l)} onChange={() => {}} style={{ accentColor: 'var(--primary)' }}/>
                      <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={l}>{l}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Search */}
            <div style={{ position: 'relative', flex: 1, minWidth: 200 }}>
              <div style={{ position: 'absolute', left: 10, top: '50%', transform: 'translateY(-50%)', color: 'var(--muted)' }}><I.Search/></div>
              <input
                className="input"
                style={{ paddingLeft: 34 }}
                placeholder="Search text, ID, or range (e.g. 1-50)..."
                value={searchQuery}
                onChange={e => handleSearchChange(e.target.value)}
              />
              {searchQuery && (
                <button onClick={() => { setSearchQuery(''); setDebouncedSearch(''); }}
                  style={{ position: 'absolute', right: 8, top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', color: 'var(--muted)' }}>
                  <I.X/>
                </button>
              )}
            </div>

            {/* Display toggles */}
            <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', alignItems: 'center' }}>
              {[
                { key: 'showOptions', label: 'Options' },
                { key: 'showAnswer', label: 'Answers' },
                { key: 'showExplanation', label: 'Explain' },
                { key: 'showTags', label: 'Tags' },
              ].map(s => (
                <button key={s.key} className="btn" onClick={() => setDisplaySettings(p => ({ ...p, [s.key]: !p[s.key] }))}
                  style={{ padding: '6px 10px', fontSize: 12, ...(displaySettings[s.key] ? { background: 'var(--primary)', color: '#fff', borderColor: 'var(--primary)' } : { opacity: 0.6 }) }}>
                  {displaySettings[s.key] ? <I.Eye/> : <I.EyeOff/>} {s.label}
                </button>
              ))}
              <button className="btn" onClick={() => setCompact(v => !v)}
                style={{ padding: '6px 10px', fontSize: 12, ...(compact ? { background: 'var(--card2)', borderColor: 'var(--border2)' } : {}) }}>
                {compact ? '‚ä° Normal' : '‚äü Compact'}
              </button>
              <button className="btn" onClick={toggleCollapseAll} style={{ padding: '6px 10px', fontSize: 12 }}>
                {collapsedIds.size > 0 ? '‚Üï Expand' : '‚Üï Collapse'}
              </button>
            </div>

            {/* Spacer */}
            <div style={{ flex: 1 }}/>

            {/* Export buttons */}
            <div style={{ display: 'flex', gap: 6 }}>
              <button className="btn" onClick={exportToText}><I.Copy/> Copy</button>
              <button className="btn" onClick={exportToPDF} disabled={isExporting}>
                {isExporting ? <I.Loader/> : <I.Download/>} PDF
              </button>
            </div>
          </div>
        </div>
      )}

      {/* === MAIN CONTENT === */}
      <main style={{ flex: 1, maxWidth: 1200, width: '100%', margin: '0 auto', padding: '20px 24px', boxSizing: 'border-box' }}>

        {/* Upload drop zone (when no questions) */}
        {!isLoading && !fetchError && questions.length === 0 && (
          <div
            className={`upload-zone ${isDragOver ? 'drag-over' : ''} animate-fade-in`}
            onDragOver={e => { e.preventDefault(); setIsDragOver(true); }}
            onDragLeave={() => setIsDragOver(false)}
            onDrop={e => {
              e.preventDefault(); setIsDragOver(false);
              const f = e.dataTransfer.files[0];
              if (f) handleFileUpload(f);
            }}
            onClick={() => fileInputRef.current?.click()}
          >
            <div style={{ fontSize: 40, marginBottom: 12 }}>üìÇ</div>
            <div style={{ fontWeight: 700, fontSize: 16, marginBottom: 6 }}>Drop your question file here</div>
            <div style={{ color: 'var(--muted)', fontSize: 13 }}>or click to browse ‚Äî supports .txt, .csv, .tsv (Anki format)</div>
          </div>
        )}

        {/* Loading */}
        {isLoading && (
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 80, gap: 16 }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 10, width: '100%', maxWidth: 600 }}>
              {[...Array(5)].map((_, i) => (
                <div key={i} className="shimmer" style={{ height: compact ? 60 : 90, borderRadius: 12, animationDelay: `${i * 0.1}s` }}/>
              ))}
            </div>
            <div style={{ color: 'var(--muted)', fontSize: 13, display: 'flex', alignItems: 'center', gap: 6 }}>
              <I.Loader/> Parsing questions...
            </div>
          </div>
        )}

        {/* Error */}
        {fetchError && !isLoading && (
          <div style={{ textAlign: 'center', padding: 60 }} className="animate-fade-in">
            <div style={{ fontSize: 36, marginBottom: 12 }}>‚ö†Ô∏è</div>
            <div style={{ fontWeight: 700, fontSize: 16, marginBottom: 8, color: 'var(--red)' }}>Failed to load file</div>
            <div style={{ color: 'var(--muted)', fontSize: 13, maxWidth: 400, margin: '0 auto 20px' }}>{fetchError}</div>
            <button className="btn btn-primary" onClick={() => fileInputRef.current?.click()}>Upload Manually</button>
          </div>
        )}

        {/* Questions list */}
        {!isLoading && !fetchError && questions.length > 0 && (
          <>
            {/* Result count */}
            <div style={{ color: 'var(--muted)', fontSize: 12, marginBottom: 14, fontFamily: 'var(--mono)' }}>
              {visibleQuestions.length === questions.length
                ? `Showing all ${questions.length} questions`
                : `Showing ${visibleQuestions.length} of ${questions.length} questions`
              }
              {debouncedSearch && <span> for "<b style={{ color: 'var(--text)' }}>{debouncedSearch}</b>"</span>}
            </div>

            {visibleQuestions.length === 0 ? (
              <div style={{ textAlign: 'center', padding: 60, border: '2px dashed var(--border2)', borderRadius: 16, color: 'var(--muted)' }} className="animate-fade-in">
                <div style={{ fontSize: 32, marginBottom: 8 }}>üîç</div>
                <div style={{ fontWeight: 600, marginBottom: 4 }}>No questions match</div>
                <div style={{ fontSize: 13 }}>Try adjusting your search or filters</div>
              </div>
            ) : (
              <div id="q-list">
                {visibleQuestions.map((q) => (
                  <QuestionCard
                    key={q.id}
                    q={q}
                    isCollapsed={collapsedIds.has(q.id)}
                    isFavorite={favoriteIds.has(q.id)}
                    isCompleted={completedIds.has(q.id)}
                    isUnsolved={!completedIds.has(q.id)}
                    displaySettings={displaySettings}
                    searchQuery={debouncedSearch}
                    onToggleCollapse={toggleCollapse}
                    onToggleFavorite={toggleFavorite}
                    onToggleCompleted={toggleCompleted}
                    onOpenNote={(qId) => setNoteModal({ qId, question: q.question })}
                    noteText={notes[q.id] || ''}
                    compact={compact}
                  />
                ))}
              </div>
            )}
          </>
        )}
      </main>

      {/* === MODALS === */}
      {showReport && (
        <ReportModal
          questions={questions}
          favoriteIds={favoriteIds}
          completedIds={completedIds}
          notes={notes}
          onClose={() => setShowReport(false)}
        />
      )}

      {showPractice && (
        <PracticeMode
          questions={practicePool}
          onClose={() => setShowPractice(false)}
        />
      )}

      {noteModal && (
        <NoteModal
          qId={noteModal.qId}
          question={noteModal.question}
          noteText={notes[noteModal.qId] || ''}
          onSave={saveNote}
          onClose={() => setNoteModal(null)}
        />
      )}

      {/* === TOAST === */}
      {toast && (
        <div className="toast" style={{
          background: toast.type === 'error' ? 'var(--red)' : toast.type === 'warn' ? 'var(--yellow)' : 'var(--green)',
          color: '#fff'
        }}>
          {toast.type === 'error' ? '‚ö†' : toast.type === 'warn' ? '‚ö†' : '‚úì'} {toast.msg}
        </div>
      )}

      {/* Close dropdowns on outside click */}
      {isLessonDropdownOpen && (
        <div style={{ position: 'fixed', inset: 0, zIndex: 50 }} onClick={() => setIsLessonDropdownOpen(false)}/>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
